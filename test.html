bash
javascript
html
cpp
<h1>rehype-shiki</h1>
<p><a href="https://github.com/rehypejs/rehype"><strong>rehype</strong></a> plugin to apply syntax highlighting on code blocks with <a href="https://github.com/octref/shiki"><strong>shiki</strong></a>.</p>
<p>This plugin was based upon <a href="https://github.com/rehypejs/rehype-highlight"><strong>rehype-highlight</strong></a>.</p>
<h2>Installation</h2>
<p><a href="https://docs.npmjs.com/cli/install">npm</a>:</p>
<pre style="background: #FFFFFF"><code class="language-bash"><span style="color: #000000">npm install rehype-shiki</span>
</code></pre>
<h2>Usage</h2>
<p>Say <code>example.html</code> looks as follows:</p>
<p>...and <code>example.js</code> like this:</p>
<pre style="background: #FFFFFF"><code class="language-javascript"><span style="color: #0000FF">var</span><span style="color: #000000"> </span><span style="color: #001080">vfile</span><span style="color: #000000"> = </span><span style="color: #795E26">require</span><span style="color: #000000">(</span><span style="color: #A31515">'to-vfile'</span><span style="color: #000000">)</span>
<span style="color: #0000FF">var</span><span style="color: #000000"> </span><span style="color: #001080">report</span><span style="color: #000000"> = </span><span style="color: #795E26">require</span><span style="color: #000000">(</span><span style="color: #A31515">'vfile-reporter'</span><span style="color: #000000">)</span>
<span style="color: #0000FF">var</span><span style="color: #000000"> </span><span style="color: #001080">rehype</span><span style="color: #000000"> = </span><span style="color: #795E26">require</span><span style="color: #000000">(</span><span style="color: #A31515">'rehype'</span><span style="color: #000000">)</span>
<span style="color: #0000FF">var</span><span style="color: #000000"> </span><span style="color: #001080">shiki</span><span style="color: #000000"> = </span><span style="color: #795E26">require</span><span style="color: #000000">(</span><span style="color: #A31515">'rehype-shiki'</span><span style="color: #000000">)</span>

<span style="color: #795E26">rehype</span><span style="color: #000000">()</span>
<span style="color: #000000">  .</span><span style="color: #795E26">data</span><span style="color: #000000">(</span><span style="color: #A31515">'settings'</span><span style="color: #000000">, {</span><span style="color: #001080">fragment:</span><span style="color: #000000"> </span><span style="color: #0000FF">true</span><span style="color: #000000">})</span>
<span style="color: #000000">  .</span><span style="color: #795E26">use</span><span style="color: #000000">(</span><span style="color: #001080">shiki</span><span style="color: #000000">)</span>
<span style="color: #000000">  .</span><span style="color: #795E26">process</span><span style="color: #000000">(</span><span style="color: #001080">vfile</span><span style="color: #000000">.</span><span style="color: #795E26">readSync</span><span style="color: #000000">(</span><span style="color: #A31515">'example.html'</span><span style="color: #000000">), </span><span style="color: #0000FF">function</span><span style="color: #000000">(</span><span style="color: #001080">err</span><span style="color: #000000">, </span><span style="color: #001080">file</span><span style="color: #000000">) {</span>
<span style="color: #000000">    </span><span style="color: #267F99">console</span><span style="color: #000000">.</span><span style="color: #795E26">error</span><span style="color: #000000">(</span><span style="color: #795E26">report</span><span style="color: #000000">(</span><span style="color: #001080">err</span><span style="color: #000000"> || </span><span style="color: #001080">file</span><span style="color: #000000">))</span>
<span style="color: #000000">    </span><span style="color: #267F99">console</span><span style="color: #000000">.</span><span style="color: #795E26">log</span><span style="color: #000000">(</span><span style="color: #267F99">String</span><span style="color: #000000">(</span><span style="color: #001080">file</span><span style="color: #000000">))</span>
<span style="color: #000000">  })</span>
</code></pre>
<p>Now, running <code>node example</code> yields:</p>
<h2>API</h2>
<h3><code>rehype().use(shiki[, options])</code></h3>
<p>Apply syntax highlighting to <code>pre > code</code> using <a href="https://github.com/octref/shiki"><strong>shiki</strong></a>; which tokenises the code block and new <a href="https://github.com/syntax-tree/hast"><strong>hast</strong></a> nodes are subsequently created from (using this plugin).</p>
<p>Configure the language by using the <code>language-foo</code> class on the <code>code</code> element.  For example;</p>
<pre style="background: #FFFFFF"><code class="language-html"><span style="color: #800000">&#x3C;pre>&#x3C;code</span><span style="color: #000000"> </span><span style="color: #FF0000">class</span><span style="color: #000000">=</span><span style="color: #0000FF">"language-js"</span><span style="color: #800000">></span><span style="color: #000000">console.log("Hello world!")</span><span style="color: #800000">&#x3C;/code>&#x3C;/pre></span>
</code></pre>
<p>This is in respect to the <a href="https://github.com/syntax-tree/mdast-util-to-hast/blob/master/lib/handlers/code.js">mdast-util-to-hast code handler</a>.</p>
<p><a href="https://github.com/octref/shiki">Shiki</a> does not perform language detection, if unknown, this plugin falls back to the theme's background and text colour (chosen as <code>settings.foreground</code> from the theme file).</p>
<h4><code>options</code></h4>
<h5><code>options.theme</code></h5>
<p><code>string</code>, default: <code>'nord'</code> - Name of shiki theme to use, otherwise path to theme file for it to load.</p>
<h5><code>options.useBackground</code></h5>
<p><code>boolean</code>, default: <code>true</code> - Whether to apply the background theme colour to the <code>pre</code> element.</p>
<h2>License</h2>
<p><a href="LICENSE">MIT</a> Â© <a href="https://rsclarke.dev">@rsclarke</a></p>
<pre style="background: #FFFFFF"><code class="language-cpp"><span style="color: #0000FF">#include </span><span style="color: #A31515">&#x3C;cstdio></span>
<span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">N</span><span style="color: #000000"> = </span><span style="color: #098658">100005</span><span style="color: #000000">;</span>
<span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">rt</span><span style="color: #000000">, </span><span style="color: #001080">tot</span><span style="color: #000000">, </span><span style="color: #001080">fa</span><span style="color: #000000">[</span><span style="color: #001080">N</span><span style="color: #000000">], </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">N</span><span style="color: #000000">][</span><span style="color: #098658">2</span><span style="color: #000000">], </span><span style="color: #001080">val</span><span style="color: #000000">[</span><span style="color: #001080">N</span><span style="color: #000000">], </span><span style="color: #001080">cnt</span><span style="color: #000000">[</span><span style="color: #001080">N</span><span style="color: #000000">], </span><span style="color: #001080">sz</span><span style="color: #000000">[</span><span style="color: #001080">N</span><span style="color: #000000">];</span>
<span style="color: #0000FF">struct</span><span style="color: #000000"> </span><span style="color: #267f99">Splay</span><span style="color: #000000"> {</span>
<span style="color: #000000">  </span><span style="color: #0000FF">void</span><span style="color: #000000"> </span><span style="color: #795E26">maintain</span><span style="color: #000000">(</span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">) { </span><span style="color: #001080">sz</span><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">] = </span><span style="color: #001080">sz</span><span style="color: #000000">[</span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">][</span><span style="color: #098658">0</span><span style="color: #000000">]] + </span><span style="color: #001080">sz</span><span style="color: #000000">[</span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">][</span><span style="color: #098658">1</span><span style="color: #000000">]] + </span><span style="color: #001080">cnt</span><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">]; }</span>
<span style="color: #000000">  </span><span style="color: #0000FF">bool</span><span style="color: #000000"> </span><span style="color: #795E26">get</span><span style="color: #000000">(</span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">) { </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000"> == </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">fa</span><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">]][</span><span style="color: #098658">1</span><span style="color: #000000">]; }</span>
<span style="color: #000000">  </span><span style="color: #0000FF">void</span><span style="color: #000000"> </span><span style="color: #795E26">clear</span><span style="color: #000000">(</span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">) {</span>
<span style="color: #000000">    </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">][</span><span style="color: #098658">0</span><span style="color: #000000">] = </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">][</span><span style="color: #098658">1</span><span style="color: #000000">] = </span><span style="color: #001080">fa</span><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">] = </span><span style="color: #001080">val</span><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">] = </span><span style="color: #001080">sz</span><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">] = </span><span style="color: #001080">cnt</span><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">] = </span><span style="color: #098658">0</span><span style="color: #000000">;</span>
<span style="color: #000000">  }</span>
<span style="color: #000000">  </span><span style="color: #0000FF">void</span><span style="color: #000000"> </span><span style="color: #795E26">rotate</span><span style="color: #000000">(</span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">) {</span>
<span style="color: #000000">    </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000"> = </span><span style="color: #001080">fa</span><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">], </span><span style="color: #001080">z</span><span style="color: #000000"> = </span><span style="color: #001080">fa</span><span style="color: #000000">[</span><span style="color: #001080">y</span><span style="color: #000000">], </span><span style="color: #001080">chk</span><span style="color: #000000"> = </span><span style="color: #795E26">get</span><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000">);</span>
<span style="color: #000000">    </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">y</span><span style="color: #000000">][</span><span style="color: #001080">chk</span><span style="color: #000000">] = </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">][</span><span style="color: #001080">chk</span><span style="color: #000000"> ^ </span><span style="color: #098658">1</span><span style="color: #000000">];</span>
<span style="color: #000000">    </span><span style="color: #001080">fa</span><span style="color: #000000">[</span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">][</span><span style="color: #001080">chk</span><span style="color: #000000"> ^ </span><span style="color: #098658">1</span><span style="color: #000000">]] = </span><span style="color: #001080">y</span><span style="color: #000000">;</span>
<span style="color: #000000">    </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">][</span><span style="color: #001080">chk</span><span style="color: #000000"> ^ </span><span style="color: #098658">1</span><span style="color: #000000">] = </span><span style="color: #001080">y</span><span style="color: #000000">;</span>
<span style="color: #000000">    </span><span style="color: #001080">fa</span><span style="color: #000000">[</span><span style="color: #001080">y</span><span style="color: #000000">] = </span><span style="color: #001080">x</span><span style="color: #000000">;</span>
<span style="color: #000000">    </span><span style="color: #001080">fa</span><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">] = </span><span style="color: #001080">z</span><span style="color: #000000">;</span>
<span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">z</span><span style="color: #000000">) </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">z</span><span style="color: #000000">][</span><span style="color: #001080">y</span><span style="color: #000000"> == </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">z</span><span style="color: #000000">][</span><span style="color: #098658">1</span><span style="color: #000000">]] = </span><span style="color: #001080">x</span><span style="color: #000000">;</span>
<span style="color: #000000">    </span><span style="color: #795E26">maintain</span><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000">);</span>
<span style="color: #000000">    </span><span style="color: #795E26">maintain</span><span style="color: #000000">(</span><span style="color: #001080">y</span><span style="color: #000000">);</span>
<span style="color: #000000">  }</span>
<span style="color: #000000">  </span><span style="color: #0000FF">void</span><span style="color: #000000"> </span><span style="color: #795E26">splay</span><span style="color: #000000">(</span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">) {</span>
<span style="color: #000000">    </span><span style="color: #0000FF">for</span><span style="color: #000000"> (</span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">f</span><span style="color: #000000"> = </span><span style="color: #001080">fa</span><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">]; </span><span style="color: #001080">f</span><span style="color: #000000"> = </span><span style="color: #001080">fa</span><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">], </span><span style="color: #001080">f</span><span style="color: #000000">; </span><span style="color: #795E26">rotate</span><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000">))</span>
<span style="color: #000000">      </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">fa</span><span style="color: #000000">[</span><span style="color: #001080">f</span><span style="color: #000000">]) </span><span style="color: #795E26">rotate</span><span style="color: #000000">(</span><span style="color: #795E26">get</span><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000">) == </span><span style="color: #795E26">get</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">) ? </span><span style="color: #001080">f</span><span style="color: #000000"> : </span><span style="color: #001080">x</span><span style="color: #000000">);</span>
<span style="color: #000000">    </span><span style="color: #001080">rt</span><span style="color: #000000"> = </span><span style="color: #001080">x</span><span style="color: #000000">;</span>
<span style="color: #000000">  }</span>
<span style="color: #000000">  </span><span style="color: #0000FF">void</span><span style="color: #000000"> </span><span style="color: #795E26">ins</span><span style="color: #000000">(</span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">k</span><span style="color: #000000">) {</span>
<span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> (!</span><span style="color: #001080">rt</span><span style="color: #000000">) {</span>
<span style="color: #000000">      </span><span style="color: #001080">val</span><span style="color: #000000">[++</span><span style="color: #001080">tot</span><span style="color: #000000">] = </span><span style="color: #001080">k</span><span style="color: #000000">;</span>
<span style="color: #000000">      </span><span style="color: #001080">cnt</span><span style="color: #000000">[</span><span style="color: #001080">tot</span><span style="color: #000000">]++;</span>
<span style="color: #000000">      </span><span style="color: #001080">rt</span><span style="color: #000000"> = </span><span style="color: #001080">tot</span><span style="color: #000000">;</span>
<span style="color: #000000">      </span><span style="color: #795E26">maintain</span><span style="color: #000000">(</span><span style="color: #001080">rt</span><span style="color: #000000">);</span>
<span style="color: #000000">      </span><span style="color: #0000FF">return</span><span style="color: #000000">;</span>
<span style="color: #000000">    }</span>
<span style="color: #000000">    </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">cnr</span><span style="color: #000000"> = </span><span style="color: #001080">rt</span><span style="color: #000000">, </span><span style="color: #001080">f</span><span style="color: #000000"> = </span><span style="color: #098658">0</span><span style="color: #000000">;</span>
<span style="color: #000000">    </span><span style="color: #0000FF">while</span><span style="color: #000000"> (</span><span style="color: #098658">1</span><span style="color: #000000">) {</span>
<span style="color: #000000">      </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">val</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">] == </span><span style="color: #001080">k</span><span style="color: #000000">) {</span>
<span style="color: #000000">        </span><span style="color: #001080">cnt</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">]++;</span>
<span style="color: #000000">        </span><span style="color: #795E26">maintain</span><span style="color: #000000">(</span><span style="color: #001080">cnr</span><span style="color: #000000">);</span>
<span style="color: #000000">        </span><span style="color: #795E26">maintain</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">);</span>
<span style="color: #000000">        </span><span style="color: #795E26">splay</span><span style="color: #000000">(</span><span style="color: #001080">cnr</span><span style="color: #000000">);</span>
<span style="color: #000000">        </span><span style="color: #0000FF">break</span><span style="color: #000000">;</span>
<span style="color: #000000">      }</span>
<span style="color: #000000">      </span><span style="color: #001080">f</span><span style="color: #000000"> = </span><span style="color: #001080">cnr</span><span style="color: #000000">;</span>
<span style="color: #000000">      </span><span style="color: #001080">cnr</span><span style="color: #000000"> = </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">][</span><span style="color: #001080">val</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">] &#x3C; </span><span style="color: #001080">k</span><span style="color: #000000">];</span>
<span style="color: #000000">      </span><span style="color: #0000FF">if</span><span style="color: #000000"> (!</span><span style="color: #001080">cnr</span><span style="color: #000000">) {</span>
<span style="color: #000000">        </span><span style="color: #001080">val</span><span style="color: #000000">[++</span><span style="color: #001080">tot</span><span style="color: #000000">] = </span><span style="color: #001080">k</span><span style="color: #000000">;</span>
<span style="color: #000000">        </span><span style="color: #001080">cnt</span><span style="color: #000000">[</span><span style="color: #001080">tot</span><span style="color: #000000">]++;</span>
<span style="color: #000000">        </span><span style="color: #001080">fa</span><span style="color: #000000">[</span><span style="color: #001080">tot</span><span style="color: #000000">] = </span><span style="color: #001080">f</span><span style="color: #000000">;</span>
<span style="color: #000000">        </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">f</span><span style="color: #000000">][</span><span style="color: #001080">val</span><span style="color: #000000">[</span><span style="color: #001080">f</span><span style="color: #000000">] &#x3C; </span><span style="color: #001080">k</span><span style="color: #000000">] = </span><span style="color: #001080">tot</span><span style="color: #000000">;</span>
<span style="color: #000000">        </span><span style="color: #795E26">maintain</span><span style="color: #000000">(</span><span style="color: #001080">tot</span><span style="color: #000000">);</span>
<span style="color: #000000">        </span><span style="color: #795E26">maintain</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">);</span>
<span style="color: #000000">        </span><span style="color: #795E26">splay</span><span style="color: #000000">(</span><span style="color: #001080">tot</span><span style="color: #000000">);</span>
<span style="color: #000000">        </span><span style="color: #0000FF">break</span><span style="color: #000000">;</span>
<span style="color: #000000">      }</span>
<span style="color: #000000">    }</span>
<span style="color: #000000">  }</span>
<span style="color: #000000">  </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #795E26">rk</span><span style="color: #000000">(</span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">k</span><span style="color: #000000">) {</span>
<span style="color: #000000">    </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">res</span><span style="color: #000000"> = </span><span style="color: #098658">0</span><span style="color: #000000">, </span><span style="color: #001080">cnr</span><span style="color: #000000"> = </span><span style="color: #001080">rt</span><span style="color: #000000">;</span>
<span style="color: #000000">    </span><span style="color: #0000FF">while</span><span style="color: #000000"> (</span><span style="color: #098658">1</span><span style="color: #000000">) {</span>
<span style="color: #000000">      </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">k</span><span style="color: #000000"> &#x3C; </span><span style="color: #001080">val</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">]) {</span>
<span style="color: #000000">        </span><span style="color: #001080">cnr</span><span style="color: #000000"> = </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">][</span><span style="color: #098658">0</span><span style="color: #000000">];</span>
<span style="color: #000000">      } </span><span style="color: #0000FF">else</span><span style="color: #000000"> {</span>
<span style="color: #000000">        </span><span style="color: #001080">res</span><span style="color: #000000"> += </span><span style="color: #001080">sz</span><span style="color: #000000">[</span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">][</span><span style="color: #098658">0</span><span style="color: #000000">]];</span>
<span style="color: #000000">        </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">k</span><span style="color: #000000"> == </span><span style="color: #001080">val</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">]) {</span>
<span style="color: #000000">          </span><span style="color: #795E26">splay</span><span style="color: #000000">(</span><span style="color: #001080">cnr</span><span style="color: #000000">);</span>
<span style="color: #000000">          </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">res</span><span style="color: #000000"> + </span><span style="color: #098658">1</span><span style="color: #000000">;</span>
<span style="color: #000000">        }</span>
<span style="color: #000000">        </span><span style="color: #001080">res</span><span style="color: #000000"> += </span><span style="color: #001080">cnt</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">];</span>
<span style="color: #000000">        </span><span style="color: #001080">cnr</span><span style="color: #000000"> = </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">][</span><span style="color: #098658">1</span><span style="color: #000000">];</span>
<span style="color: #000000">      }</span>
<span style="color: #000000">    }</span>
<span style="color: #000000">  }</span>
<span style="color: #000000">  </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #795E26">kth</span><span style="color: #000000">(</span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">k</span><span style="color: #000000">) {</span>
<span style="color: #000000">    </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">cnr</span><span style="color: #000000"> = </span><span style="color: #001080">rt</span><span style="color: #000000">;</span>
<span style="color: #000000">    </span><span style="color: #0000FF">while</span><span style="color: #000000"> (</span><span style="color: #098658">1</span><span style="color: #000000">) {</span>
<span style="color: #000000">      </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">][</span><span style="color: #098658">0</span><span style="color: #000000">] &#x26;&#x26; </span><span style="color: #001080">k</span><span style="color: #000000"> &#x3C;= </span><span style="color: #001080">sz</span><span style="color: #000000">[</span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">][</span><span style="color: #098658">0</span><span style="color: #000000">]]) {</span>
<span style="color: #000000">        </span><span style="color: #001080">cnr</span><span style="color: #000000"> = </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">][</span><span style="color: #098658">0</span><span style="color: #000000">];</span>
<span style="color: #000000">      } </span><span style="color: #0000FF">else</span><span style="color: #000000"> {</span>
<span style="color: #000000">        </span><span style="color: #001080">k</span><span style="color: #000000"> -= </span><span style="color: #001080">cnt</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">] + </span><span style="color: #001080">sz</span><span style="color: #000000">[</span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">][</span><span style="color: #098658">0</span><span style="color: #000000">]];</span>
<span style="color: #000000">        </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">k</span><span style="color: #000000"> &#x3C;= </span><span style="color: #098658">0</span><span style="color: #000000">) {</span>
<span style="color: #000000">          </span><span style="color: #795E26">splay</span><span style="color: #000000">(</span><span style="color: #001080">cnr</span><span style="color: #000000">);</span>
<span style="color: #000000">          </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">val</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">];</span>
<span style="color: #000000">        }</span>
<span style="color: #000000">        </span><span style="color: #001080">cnr</span><span style="color: #000000"> = </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">][</span><span style="color: #098658">1</span><span style="color: #000000">];</span>
<span style="color: #000000">      }</span>
<span style="color: #000000">    }</span>
<span style="color: #000000">  }</span>
<span style="color: #000000">  </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #795E26">pre</span><span style="color: #000000">() {</span>
<span style="color: #000000">    </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">cnr</span><span style="color: #000000"> = </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">rt</span><span style="color: #000000">][</span><span style="color: #098658">0</span><span style="color: #000000">];</span>
<span style="color: #000000">    </span><span style="color: #0000FF">while</span><span style="color: #000000"> (</span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">][</span><span style="color: #098658">1</span><span style="color: #000000">]) </span><span style="color: #001080">cnr</span><span style="color: #000000"> = </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">][</span><span style="color: #098658">1</span><span style="color: #000000">];</span>
<span style="color: #000000">    </span><span style="color: #795E26">splay</span><span style="color: #000000">(</span><span style="color: #001080">cnr</span><span style="color: #000000">);</span>
<span style="color: #000000">    </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">cnr</span><span style="color: #000000">;</span>
<span style="color: #000000">  }</span>
<span style="color: #000000">  </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #795E26">nxt</span><span style="color: #000000">() {</span>
<span style="color: #000000">    </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">cnr</span><span style="color: #000000"> = </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">rt</span><span style="color: #000000">][</span><span style="color: #098658">1</span><span style="color: #000000">];</span>
<span style="color: #000000">    </span><span style="color: #0000FF">while</span><span style="color: #000000"> (</span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">][</span><span style="color: #098658">0</span><span style="color: #000000">]) </span><span style="color: #001080">cnr</span><span style="color: #000000"> = </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">][</span><span style="color: #098658">0</span><span style="color: #000000">];</span>
<span style="color: #000000">    </span><span style="color: #795E26">splay</span><span style="color: #000000">(</span><span style="color: #001080">cnr</span><span style="color: #000000">);</span>
<span style="color: #000000">    </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">cnr</span><span style="color: #000000">;</span>
<span style="color: #000000">  }</span>
<span style="color: #000000">  </span><span style="color: #0000FF">void</span><span style="color: #000000"> </span><span style="color: #795E26">del</span><span style="color: #000000">(</span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">k</span><span style="color: #000000">) {</span>
<span style="color: #000000">    </span><span style="color: #795E26">rk</span><span style="color: #000000">(</span><span style="color: #001080">k</span><span style="color: #000000">);</span>
<span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">cnt</span><span style="color: #000000">[</span><span style="color: #001080">rt</span><span style="color: #000000">] > </span><span style="color: #098658">1</span><span style="color: #000000">) {</span>
<span style="color: #000000">      </span><span style="color: #001080">cnt</span><span style="color: #000000">[</span><span style="color: #001080">rt</span><span style="color: #000000">]--;</span>
<span style="color: #000000">      </span><span style="color: #795E26">maintain</span><span style="color: #000000">(</span><span style="color: #001080">rt</span><span style="color: #000000">);</span>
<span style="color: #000000">      </span><span style="color: #0000FF">return</span><span style="color: #000000">;</span>
<span style="color: #000000">    }</span>
<span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> (!</span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">rt</span><span style="color: #000000">][</span><span style="color: #098658">0</span><span style="color: #000000">] &#x26;&#x26; !</span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">rt</span><span style="color: #000000">][</span><span style="color: #098658">1</span><span style="color: #000000">]) {</span>
<span style="color: #000000">      </span><span style="color: #795E26">clear</span><span style="color: #000000">(</span><span style="color: #001080">rt</span><span style="color: #000000">);</span>
<span style="color: #000000">      </span><span style="color: #001080">rt</span><span style="color: #000000"> = </span><span style="color: #098658">0</span><span style="color: #000000">;</span>
<span style="color: #000000">      </span><span style="color: #0000FF">return</span><span style="color: #000000">;</span>
<span style="color: #000000">    }</span>
<span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> (!</span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">rt</span><span style="color: #000000">][</span><span style="color: #098658">0</span><span style="color: #000000">]) {</span>
<span style="color: #000000">      </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">cnr</span><span style="color: #000000"> = </span><span style="color: #001080">rt</span><span style="color: #000000">;</span>
<span style="color: #000000">      </span><span style="color: #001080">rt</span><span style="color: #000000"> = </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">rt</span><span style="color: #000000">][</span><span style="color: #098658">1</span><span style="color: #000000">];</span>
<span style="color: #000000">      </span><span style="color: #001080">fa</span><span style="color: #000000">[</span><span style="color: #001080">rt</span><span style="color: #000000">] = </span><span style="color: #098658">0</span><span style="color: #000000">;</span>
<span style="color: #000000">      </span><span style="color: #795E26">clear</span><span style="color: #000000">(</span><span style="color: #001080">cnr</span><span style="color: #000000">);</span>
<span style="color: #000000">      </span><span style="color: #0000FF">return</span><span style="color: #000000">;</span>
<span style="color: #000000">    }</span>
<span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> (!</span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">rt</span><span style="color: #000000">][</span><span style="color: #098658">1</span><span style="color: #000000">]) {</span>
<span style="color: #000000">      </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">cnr</span><span style="color: #000000"> = </span><span style="color: #001080">rt</span><span style="color: #000000">;</span>
<span style="color: #000000">      </span><span style="color: #001080">rt</span><span style="color: #000000"> = </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">rt</span><span style="color: #000000">][</span><span style="color: #098658">0</span><span style="color: #000000">];</span>
<span style="color: #000000">      </span><span style="color: #001080">fa</span><span style="color: #000000">[</span><span style="color: #001080">rt</span><span style="color: #000000">] = </span><span style="color: #098658">0</span><span style="color: #000000">;</span>
<span style="color: #000000">      </span><span style="color: #795E26">clear</span><span style="color: #000000">(</span><span style="color: #001080">cnr</span><span style="color: #000000">);</span>
<span style="color: #000000">      </span><span style="color: #0000FF">return</span><span style="color: #000000">;</span>
<span style="color: #000000">    }</span>
<span style="color: #000000">    </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">cnr</span><span style="color: #000000"> = </span><span style="color: #001080">rt</span><span style="color: #000000">;</span>
<span style="color: #000000">    </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000"> = </span><span style="color: #795E26">pre</span><span style="color: #000000">();</span>
<span style="color: #000000">    </span><span style="color: #795E26">splay</span><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000">);</span>
<span style="color: #000000">    </span><span style="color: #001080">fa</span><span style="color: #000000">[</span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">][</span><span style="color: #098658">1</span><span style="color: #000000">]] = </span><span style="color: #001080">x</span><span style="color: #000000">;</span>
<span style="color: #000000">    </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">][</span><span style="color: #098658">1</span><span style="color: #000000">] = </span><span style="color: #001080">ch</span><span style="color: #000000">[</span><span style="color: #001080">cnr</span><span style="color: #000000">][</span><span style="color: #098658">1</span><span style="color: #000000">];</span>
<span style="color: #000000">    </span><span style="color: #795E26">clear</span><span style="color: #000000">(</span><span style="color: #001080">cnr</span><span style="color: #000000">);</span>
<span style="color: #000000">    </span><span style="color: #795E26">maintain</span><span style="color: #000000">(</span><span style="color: #001080">rt</span><span style="color: #000000">);</span>
<span style="color: #000000">  }</span>
<span style="color: #000000">} </span><span style="color: #001080">tree</span><span style="color: #000000">;</span>

<span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #795E26">main</span><span style="color: #000000">() {</span>
<span style="color: #000000">  </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #001080">n</span><span style="color: #000000">, </span><span style="color: #001080">opt</span><span style="color: #000000">, </span><span style="color: #001080">x</span><span style="color: #000000">;</span>
<span style="color: #000000">  </span><span style="color: #0000FF">for</span><span style="color: #000000"> (</span><span style="color: #795E26">scanf</span><span style="color: #000000">(</span><span style="color: #A31515">"%d"</span><span style="color: #000000">, &#x26;</span><span style="color: #001080">n</span><span style="color: #000000">); </span><span style="color: #001080">n</span><span style="color: #000000">; --</span><span style="color: #001080">n</span><span style="color: #000000">) {</span>
<span style="color: #000000">    </span><span style="color: #795E26">scanf</span><span style="color: #000000">(</span><span style="color: #A31515">"%d%d"</span><span style="color: #000000">, &#x26;</span><span style="color: #001080">opt</span><span style="color: #000000">, &#x26;</span><span style="color: #001080">x</span><span style="color: #000000">);</span>
<span style="color: #000000">    </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">opt</span><span style="color: #000000"> == </span><span style="color: #098658">1</span><span style="color: #000000">)</span>
<span style="color: #000000">      </span><span style="color: #001080">tree</span><span style="color: #000000">.</span><span style="color: #795E26">ins</span><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000">);</span>
<span style="color: #000000">    </span><span style="color: #0000FF">else</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">opt</span><span style="color: #000000"> == </span><span style="color: #098658">2</span><span style="color: #000000">)</span>
<span style="color: #000000">      </span><span style="color: #001080">tree</span><span style="color: #000000">.</span><span style="color: #795E26">del</span><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000">);</span>
<span style="color: #000000">    </span><span style="color: #0000FF">else</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">opt</span><span style="color: #000000"> == </span><span style="color: #098658">3</span><span style="color: #000000">)</span>
<span style="color: #000000">      </span><span style="color: #795E26">printf</span><span style="color: #000000">(</span><span style="color: #A31515">"%d</span><span style="color: #FF0000">\n</span><span style="color: #A31515">"</span><span style="color: #000000">, </span><span style="color: #001080">tree</span><span style="color: #000000">.</span><span style="color: #795E26">rk</span><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000">));</span>
<span style="color: #000000">    </span><span style="color: #0000FF">else</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">opt</span><span style="color: #000000"> == </span><span style="color: #098658">4</span><span style="color: #000000">)</span>
<span style="color: #000000">      </span><span style="color: #795E26">printf</span><span style="color: #000000">(</span><span style="color: #A31515">"%d</span><span style="color: #FF0000">\n</span><span style="color: #A31515">"</span><span style="color: #000000">, </span><span style="color: #001080">tree</span><span style="color: #000000">.</span><span style="color: #795E26">kth</span><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000">));</span>
<span style="color: #000000">    </span><span style="color: #0000FF">else</span><span style="color: #000000"> </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">opt</span><span style="color: #000000"> == </span><span style="color: #098658">5</span><span style="color: #000000">)</span>
<span style="color: #000000">      </span><span style="color: #001080">tree</span><span style="color: #000000">.</span><span style="color: #795E26">ins</span><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000">), </span><span style="color: #795E26">printf</span><span style="color: #000000">(</span><span style="color: #A31515">"%d</span><span style="color: #FF0000">\n</span><span style="color: #A31515">"</span><span style="color: #000000">, </span><span style="color: #001080">val</span><span style="color: #000000">[</span><span style="color: #001080">tree</span><span style="color: #000000">.</span><span style="color: #795E26">pre</span><span style="color: #000000">()]), </span><span style="color: #001080">tree</span><span style="color: #000000">.</span><span style="color: #795E26">del</span><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000">);</span>
<span style="color: #000000">    </span><span style="color: #0000FF">else</span>
<span style="color: #000000">      </span><span style="color: #001080">tree</span><span style="color: #000000">.</span><span style="color: #795E26">ins</span><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000">), </span><span style="color: #795E26">printf</span><span style="color: #000000">(</span><span style="color: #A31515">"%d</span><span style="color: #FF0000">\n</span><span style="color: #A31515">"</span><span style="color: #000000">, </span><span style="color: #001080">val</span><span style="color: #000000">[</span><span style="color: #001080">tree</span><span style="color: #000000">.</span><span style="color: #795E26">nxt</span><span style="color: #000000">()]), </span><span style="color: #001080">tree</span><span style="color: #000000">.</span><span style="color: #795E26">del</span><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000">);</span>
<span style="color: #000000">  }</span>
<span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #098658">0</span><span style="color: #000000">;</span>
<span style="color: #000000">}</span>
</code></pre>
